{% extends 'base.html' %}
{% block title %}My Orders{% endblock %}

{% block content %}
<div class="row g-0">
    <!-- Buyer Sidebar -->
    <nav class="col-md-2 d-md-block bg-dark sidebar vh-100 p-3">
        <h4 class="text-white mb-4">Buyer Menu</h4>
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link text-white" href="{% url 'buyer_dashboard' %}"><i
                        class="bi bi-shop me-2"></i> Discover</a></li>
            <li class="nav-item"><a class="nav-link text-white" href="#"><i class="bi bi-heart me-2"></i> Wishlist</a>
            </li>
            <li class="nav-item"><a class="nav-link text-white active" href="{% url 'my_orders' %}"><i
                        class="bi bi-receipt me-2"></i> My Orders</a></li>
            <li class="nav-item mt-auto">
                <hr class="text-white"><a class="nav-link text-danger" href="{% url 'logout' %}"><i
                        class="bi bi-box-arrow-right me-2"></i> Logout</a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="col-md-10 p-4">
        <h1>My Order History</h1>
        <hr>
        <div class="list-group">
            {% for order in orders %}
            <div
                class="list-group-item list-group-item-action flex-column align-items-start mb-3 bg-dark-subtle border-secondary">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">Order #{{ order.id }} - {{ order.product.name }}</h5>
                    <small>{{ order.created_at|date:"d M Y" }}</small>
                </div>
                <p class="mb-1">Quantity: {{ order.quantity }} | Total: ${{ order.product.price|floatformat:2 }} x {{
                    order.quantity }} = <strong>${% widthratio order.product.price 1 order.quantity %}</strong></p>
                <p class="mb-1">Status: <span class="badge 
                    {% if order.status == 'pending_approval' %}bg-warning text-dark
                    {% elif order.status == 'pending_payment' %}bg-info text-dark
                    {% elif order.status == 'rejected' %}bg-danger
                    {% elif order.status == 'completed' %}bg-success
                    {% else %}bg-secondary{% endif %}">{{ order.get_status_display }}</span>
                </p>
                <div class="mt-3">
                    <h6>Order Timeline:</h6>
                    <ul class="list-unstyled small">
                        {% for event in order.history_events.all %}
                        <li>
                            <i class="bi bi-check-circle-fill text-success"></i>
                            <strong>{{ event.get_status_display }}</strong> -
                            <span class="text-muted">{{ event.timestamp|date:"d M Y, h:i A" }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% if order.status == 'pending_payment' %}
                <a href="{% url 'process_payment' order.id %}" class="btn btn-sm btn-success mt-2">
                    <i class="bi bi-credit-card me-2"></i>Proceed to Payment
                </a>
                {% endif %}
                <a href="{% url 'order_conversation' order.id %}" class="btn btn-sm btn-outline-info">Messages</a>
            </div>
            {% empty %}
            <p>You have not placed any orders yet.</p>
            {% endfor %}
        </div>
    </main>
</div>
{% endblock %}