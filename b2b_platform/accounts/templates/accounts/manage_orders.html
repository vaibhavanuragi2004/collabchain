{% extends 'base.html' %}
{% block title %}Manage Incoming Orders{% endblock %}

{% block content %}
<div class="row g-0">
    <!-- Seller Sidebar -->
    <nav class="col-md-2 d-md-block bg-dark sidebar vh-100 p-3">
        <h4 class="text-white mb-4">Seller Menu</h4>
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link text-white" href="{% url 'product_list' %}"><i class="bi bi-box-seam me-2"></i> My Products</a></li>
            <li class="nav-item"><a class="nav-link text-white active" href="{% url 'manage_orders' %}"><i class="bi bi-list-check me-2"></i> Manage Orders</a></li>
            <li class="nav-item mt-auto"><hr class="text-white"><a class="nav-link text-danger" href="{% url 'logout' %}"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="col-md-10 p-4">
        <h1>Manage Incoming Orders</h1>
        <hr>
        <div class="list-group">
            {% for order in orders %}
            <div class="list-group-item list-group-item-action flex-column align-items-start mb-3 bg-dark-subtle border-secondary">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">Order #{{ order.id }} - {{ order.product.name }}</h5>
                    <small>{{ order.created_at|date:"d M Y" }}</small>
                </div>
                <p class="mb-1">From Buyer: {{ order.buyer.email }}</p>
                <p class="mb-1">Quantity: {{ order.quantity }} | Total: <strong>${% widthratio order.product.price 1 order.quantity %}</strong></p>
                <p class="mb-1">Status: <span class="badge 
                    {% if order.status == 'pending_approval' %}bg-warning text-dark
                    {% elif order.status == 'pending_payment' %}bg-info text-dark
                    {% elif order.status == 'paid' %}bg-primary
                    {% elif order.status == 'shipped' %}bg-primary
                    {% elif order.status == 'completed' %}bg-success
                    {% elif order.status == 'rejected' %}bg-danger
                    {% else %}bg-secondary{% endif %}">{{ order.get_status_display }}</span>
                </p>
                
                <div class="mt-2">
                    <!-- Buttons for Pending Approval -->
                    {% if order.status == 'pending_approval' %}
                        <form action="{% url 'accept_order' order.id %}" method="post" style="display: inline;">
                            {% csrf_token %}<button type="submit" class="btn btn-sm btn-success">Accept</button>
                        </form>
                        <form action="{% url 'reject_order' order.id %}" method="post" style="display: inline;">
                            {% csrf_token %}<button type="submit" class="btn btn-sm btn-danger">Reject</button>
                        </form>
                    {% endif %}

                    <!-- Button for Paid -->
                    {% if order.status == 'paid' %}
                        <form action="{% url 'ship_order' order.id %}" method="post" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-info">Mark as Shipped</button>
                        </form>
                    {% endif %}

                    <!-- Button for Shipped -->
                    {% if order.status == 'shipped' %}
                        <form action="{% url 'complete_order' order.id %}" method="post" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-success">Mark as Completed</button>
                        </form>
                    {% endif %}
                    <a href="{% url 'order_conversation' order.id %}" class="btn btn-sm btn-outline-info">Messages</a>
                </div>
            </div>
            {% empty %}
            <p>You have no incoming orders.</p>
            {% endfor %}
        </div>
    </main>
</div>
{% endblock %}